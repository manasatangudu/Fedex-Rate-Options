@isTest
public with sharing class FedexExtractorControllerTest {
  @isTest
  public static void testGetRateOptions() {
    FedexCalloutMock mock = new FedexCalloutMock();

    String mockTokenJson = '{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzY29wZSI6WyJDWFMiXSwiUGF5bG9hZCI6eyJjbGllbnRJZGVudGl0eSI6eyJjbGllbnRLZXkiOiJsNzZkNzc5NTNhMGYzMjRmYTI5MTA4MzRlNjMyZmI3OWVkIn0sImF1dGhlbnRpY2F0aW9uUmVhbG0iOiJDTUFDIiwiYWRkaXRpb25hbElkZW50aXR5Ijp7InRpbWVTdGFtcCI6IjEzLU5vdi0yMDIyIDIyOjQ1OjI5IEVTVCIsImdyYW50X3R5cGUiOiJjbGllbnRfY3JlZGVudGlhbHMiLCJhcGltb2RlIjoiU2FuZGJveCIsImN4c0lzcyI6Imh0dHBzOi8vY3hzYXV0aHNlcnZlci1wcm9kLmFwcC5wYWFzLmZlZGV4LmNvbS90b2tlbi9vYXV0aDIifSwicGVyc29uYVR5cGUiOiJEaXJlY3RJbn   <... truncated: 642 ...>   67s_kUdDGp-qgdr6DcwIP9u5JCYsByzGaFsEsLP4Wjv2PWQQkBeJ-f4GUaovDgJlxkFHyNor3Ga9ri1ckBc8jPi1p3Q_nGvtC_GUTNOhXYAcjM9MW4j8FCBxL-5b7Z8FDloS5i1szsRfWPOA","token_type":"bearer","expires_in":3599,"scope":"CXS"}';
    mock.addResponse(mockTokenJson, 200);

    String mockRateOptionsJson = '{"transactionId":"df1f57f6-421f-49cf-a8cb-992f5b30b7c6","output":{"alerts":[{"code":"ORIGIN.STATEORPROVINCECODE.CHANGED","message":"The origin state/province code has been changed.","alertType":"NOTE"},{"code":"DESTINATION.STATEORPROVINCECODE.CHANGED","message":"The destination state/province code has been changed.","alertType":"NOTE"}],"rateReplyDetails":[{"serviceType":"FIRST_OVERNIGHT","serviceName":"FedEx First Overnight®","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":91.64,"totalNetCharge":109.51,"totalNetFedExCharge":109.51,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":17.87,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":17.87}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"6"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":91.64,"netFreight":91.64,"totalSurcharges":17.87,"netFedExCharge":109.51,"totalTaxes":0.0,"netCharge":109.51,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":17.87}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"1ST OVR","airportId":"SJC","serviceCode":"06"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000006","serviceType":"FIRST_OVERNIGHT","code":"06","names":[{"type":"long","encoding":"utf-8","value":"FedEx First OvernightÂ®"},{"type":"long","encoding":"ascii","value":"FedEx First Overnight"},{"type":"medium","encoding":"utf-8","value":"FedEx First OvernightÂ®"},{"type":"medium","encoding":"ascii","value":"FedEx First Overnight"},{"type":"short","encoding":"utf-8","value":"FO"},{"type":"short","encoding":"ascii","value":"FO"},{"type":"abbrv","encoding":"ascii","value":"FO"}],"serviceCategory":"parcel","description":"First Overnight","astraDescription":"1ST OVR"}},{"serviceType":"FEDEX_FIRST_OVERNIGHT_EXTRA_HOURS","serviceName":"FedEx First Overnight® EH","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":91.64,"totalNetCharge":109.51,"totalNetFedExCharge":109.51,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":17.87,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":17.87}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"4"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":91.64,"netFreight":91.64,"totalSurcharges":17.87,"netFedExCharge":109.51,"totalTaxes":0.0,"netCharge":109.51,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":17.87}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"EHFO","airportId":"SJC","serviceCode":"E6"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000290","serviceType":"FEDEX_FIRST_OVERNIGHT_EXTRA_HOURS","code":"E6","names":[{"type":"long","encoding":"utf-8","value":"FedEx First OvernightÂ® EH"},{"type":"long","encoding":"ascii","value":"FedEx First Overnight EH"},{"type":"medium","encoding":"utf-8","value":"FedEx First OvernightÂ® EH"},{"type":"medium","encoding":"ascii","value":"FedEx First Overnight EH"},{"type":"short","encoding":"utf-8","value":"EHFO"},{"type":"short","encoding":"ascii","value":"EHFO"},{"type":"abbrv","encoding":"ascii","value":"CA"}],"serviceCategory":"parcel","description":"Extra Hours First Overnight","astraDescription":"EHFO"}},{"serviceType":"PRIORITY_OVERNIGHT","serviceName":"FedEx Priority Overnight®","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":60.64,"totalNetCharge":72.46,"totalNetFedExCharge":72.46,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":11.82,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.82}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"1486"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":60.64,"netFreight":60.64,"totalSurcharges":11.82,"netFedExCharge":72.46,"totalTaxes":0.0,"netCharge":72.46,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.82}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"P1","airportId":"SJC","serviceCode":"01"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000002","serviceType":"PRIORITY_OVERNIGHT","code":"01","names":[{"type":"long","encoding":"utf-8","value":"FedEx Priority OvernightÂ®"},{"type":"long","encoding":"ascii","value":"FedEx Priority Overnight"},{"type":"medium","encoding":"utf-8","value":"FedEx Priority OvernightÂ®"},{"type":"medium","encoding":"ascii","value":"FedEx Priority Overnight"},{"type":"short","encoding":"utf-8","value":"P-1"},{"type":"short","encoding":"ascii","value":"P-1"},{"type":"abbrv","encoding":"ascii","value":"PO"}],"serviceCategory":"parcel","description":"Priority Overnight","astraDescription":"P1"}},{"serviceType":"FEDEX_PRIORITY_OVERNIGHT_EXTRA_HOURS","serviceName":"FedEx Priority Overnight® EH","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":60.64,"totalNetCharge":72.46,"totalNetFedExCharge":72.46,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":11.82,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.82}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"4"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":60.64,"netFreight":60.64,"totalSurcharges":11.82,"netFedExCharge":72.46,"totalTaxes":0.0,"netCharge":72.46,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.82}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"EHPO","airportId":"SJC","serviceCode":"E1"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000291","serviceType":"FEDEX_PRIORITY_OVERNIGHT_EXTRA_HOURS","code":"E1","names":[{"type":"long","encoding":"utf-8","value":"FedEx Priority OvernightÂ® EH"},{"type":"long","encoding":"ascii","value":"FedEx Priority Overnight EH"},{"type":"medium","encoding":"utf-8","value":"FedEx Priority OvernightÂ® EH"},{"type":"medium","encoding":"ascii","value":"FedEx Priority Overnight EH"},{"type":"short","encoding":"utf-8","value":"EHPO"},{"type":"short","encoding":"ascii","value":"EHPO"},{"type":"abbrv","encoding":"ascii","value":"AL"}],"serviceCategory":"parcel","description":"Extra Hours Priority","astraDescription":"EHPO"}},{"serviceType":"STANDARD_OVERNIGHT","serviceName":"FedEx Standard Overnight®","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":57.22,"totalNetCharge":68.38,"totalNetFedExCharge":68.38,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":11.16,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.16}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"1283"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":57.22,"netFreight":57.22,"totalSurcharges":11.16,"netFedExCharge":68.38,"totalTaxes":0.0,"netCharge":68.38,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.16}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"STD OVR","airportId":"SJC","serviceCode":"05"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000005","serviceType":"STANDARD_OVERNIGHT","code":"05","names":[{"type":"long","encoding":"utf-8","value":"FedEx Standard OvernightÂ®"},{"type":"long","encoding":"ascii","value":"FedEx Standard Overnight"},{"type":"medium","encoding":"utf-8","value":"FedEx Standard OvernightÂ®"},{"type":"medium","encoding":"ascii","value":"FedEx Standard Overnight"},{"type":"short","encoding":"utf-8","value":"SOS"},{"type":"short","encoding":"ascii","value":"SOS"},{"type":"abbrv","encoding":"ascii","value":"SO"}],"serviceCategory":"parcel","description":"Standard Overnight","astraDescription":"STD OVR"}},{"serviceType":"FEDEX_STANDARD_OVERNIGHT_EXTRA_HOURS","serviceName":"FedEx Standard Overnight® EH","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":57.22,"totalNetCharge":68.38,"totalNetFedExCharge":68.38,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":11.16,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.16}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"4"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":57.22,"netFreight":57.22,"totalSurcharges":11.16,"netFedExCharge":68.38,"totalTaxes":0.0,"netCharge":68.38,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":11.16}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"EHSO","airportId":"SJC","serviceCode":"E5"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000292","serviceType":"FEDEX_STANDARD_OVERNIGHT_EXTRA_HOURS","code":"E5","names":[{"type":"long","encoding":"utf-8","value":"FedEx Standard OvernightÂ® EH"},{"type":"long","encoding":"ascii","value":"FedEx Standard Overnight EH"},{"type":"medium","encoding":"utf-8","value":"FedEx Standard OvernightÂ® EH"},{"type":"medium","encoding":"ascii","value":"FedEx Standard Overnight EH"},{"type":"short","encoding":"utf-8","value":"EHSO"},{"type":"short","encoding":"ascii","value":"EHSO"},{"type":"abbrv","encoding":"ascii","value":"KO"}],"serviceCategory":"parcel","description":"Extra Hours Std Overnight","astraDescription":"EHSO"}},{"serviceType":"FEDEX_2_DAY_AM","serviceName":"FedEx 2Day® AM","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":42.57,"totalNetCharge":50.87,"totalNetFedExCharge":50.87,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":8.3,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":8.3}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"4"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":42.57,"netFreight":42.57,"totalSurcharges":8.3,"netFedExCharge":50.87,"totalTaxes":0.0,"netCharge":50.87,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":8.3}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"2DAY AM","airportId":"SJC","serviceCode":"49"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000023","serviceType":"FEDEX_2_DAY_AM","code":"49","names":[{"type":"long","encoding":"utf-8","value":"FedEx 2DayÂ® AM"},{"type":"long","encoding":"ascii","value":"FedEx 2Day AM"},{"type":"medium","encoding":"utf-8","value":"FedEx 2DayÂ® AM"},{"type":"medium","encoding":"ascii","value":"FedEx 2Day AM"},{"type":"short","encoding":"utf-8","value":"E2AM"},{"type":"short","encoding":"ascii","value":"E2AM"},{"type":"abbrv","encoding":"ascii","value":"TA"}],"serviceCategory":"parcel","description":"2DAY AM","astraDescription":"2DAY AM"}},{"serviceType":"FEDEX_2_DAY","serviceName":"FedEx 2Day®","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":37.78,"totalNetCharge":45.15,"totalNetFedExCharge":45.15,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":7.37,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":7.37}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"5980"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":37.78,"netFreight":37.78,"totalSurcharges":7.37,"netFedExCharge":45.15,"totalTaxes":0.0,"netCharge":45.15,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":7.37}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"E2","airportId":"SJC","serviceCode":"03"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000003","serviceType":"FEDEX_2_DAY","code":"03","names":[{"type":"long","encoding":"utf-8","value":"FedEx 2DayÂ®"},{"type":"long","encoding":"ascii","value":"FedEx 2Day"},{"type":"medium","encoding":"utf-8","value":"FedEx 2DayÂ®"},{"type":"medium","encoding":"ascii","value":"FedEx 2Day"},{"type":"short","encoding":"utf-8","value":"P-2"},{"type":"short","encoding":"ascii","value":"P-2"},{"type":"abbrv","encoding":"ascii","value":"ES"}],"serviceCategory":"parcel","description":"2Day","astraDescription":"E2"}},{"serviceType":"FEDEX_EXPRESS_SAVER","serviceName":"FedEx Express Saver®","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":34.27,"totalNetCharge":40.95,"totalNetFedExCharge":40.95,"shipmentRateDetail":{"rateZone":"02","dimDivisor":0,"fuelSurchargePercent":19.5,"totalSurcharges":6.68,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":6.68}],"pricingCode":"PACKAGE","totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD","rateScale":"7167"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":34.27,"netFreight":34.27,"totalSurcharges":6.68,"netFedExCharge":40.95,"totalTaxes":0.0,"netCharge":40.95,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","amount":6.68}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"XS","airportId":"SJC","serviceCode":"20"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000013","serviceType":"FEDEX_EXPRESS_SAVER","code":"20","names":[{"type":"long","encoding":"utf-8","value":"FedEx Express SaverÂ®"},{"type":"long","encoding":"ascii","value":"FedEx Express Saver"},{"type":"medium","encoding":"utf-8","value":"FedEx Express SaverÂ®"},{"type":"medium","encoding":"ascii","value":"FedEx Express Saver"}],"serviceCategory":"parcel","description":"Express Saver","astraDescription":"XS"}},{"serviceType":"FEDEX_GROUND","serviceName":"FedEx Ground®","packagingType":"YOUR_PACKAGING","ratedShipmentDetails":[{"rateType":"ACCOUNT","ratedWeightMethod":"ACTUAL","totalDiscounts":0.0,"totalBaseCharge":14.12,"totalNetCharge":16.59,"totalNetFedExCharge":16.59,"shipmentRateDetail":{"rateZone":"2","dimDivisor":0,"fuelSurchargePercent":17.5,"totalSurcharges":2.47,"totalFreightDiscount":0.0,"surCharges":[{"type":"FUEL","description":"Fuel Surcharge","level":"PACKAGE","amount":2.47}],"totalBillingWeight":{"units":"LB","value":15.0},"currency":"USD"},"ratedPackages":[{"groupNumber":0,"effectiveNetDiscount":0.0,"packageRateDetail":{"rateType":"PAYOR_ACCOUNT_PACKAGE","ratedWeightMethod":"ACTUAL","baseCharge":14.12,"netFreight":14.12,"totalSurcharges":2.47,"netFedExCharge":16.59,"totalTaxes":0.0,"netCharge":16.59,"totalRebates":0.0,"billingWeight":{"units":"LB","value":15.0},"totalFreightDiscounts":0.0,"surcharges":[{"type":"FUEL","description":"Fuel Surcharge","level":"PACKAGE","amount":2.47}],"currency":"USD"}}],"currency":"USD"}],"operationalDetail":{"ineligibleForMoneyBackGuarantee":false,"astraDescription":"FXG","airportId":"SJC","serviceCode":"92"},"signatureOptionType":"SERVICE_DEFAULT","serviceDescription":{"serviceId":"EP1000000134","serviceType":"FEDEX_GROUND","code":"92","names":[{"type":"long","encoding":"utf-8","value":"FedEx GroundÂ®"},{"type":"long","encoding":"ascii","value":"FedEx Ground"},{"type":"medium","encoding":"utf-8","value":"GroundÂ®"},{"type":"medium","encoding":"ascii","value":"Ground"},{"type":"short","encoding":"utf-8","value":"FG"},{"type":"short","encoding":"ascii","value":"FG"},{"type":"abbrv","encoding":"ascii","value":"SG"}],"description":"FedEx Ground","astraDescription":"FXG"}}],"quoteDate":"2022-11-13","encoded":false}}';
    mock.addResponse(mockRateOptionsJson, 200);

    Test.setMock(HttpCalloutMock.class, mock);
    String recipient = '{"city":"Mountain View","street":"468 Ellis Street","state":"CA","countryCode":"US","countryLabel":"United States","postalCode":"94043","country":"United States"}';
    String shipper = '{"city":"Menlo Park","street":"Facebook Way","state":"CA","countryCode":"US","countryLabel":"United States","postalCode":"94025","country":"United States"}';
    Decimal weight = 15.00;

    test.startTest();
    String response = FedexRateExtractorController.getRateOptions(
      recipient,
      shipper,
      weight
    );
    test.stopTest();

    List<RateResponseMsg.RateReplyDetailsMsg> rateOptions = (List<RateResponseMsg.RateReplyDetailsMsg>) JSON.deserialize(
      response,
      List<RateResponseMsg.RateReplyDetailsMsg>.class
    );
    System.assertEquals(10, rateOptions.size());
  }

  @isTest
  public static void testGetRateOptionsFailure() {
    FedexCalloutMock mock = new FedexCalloutMock();
    String mockTokenJson = '{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzY29wZSI6WyJDWFMiXSwiUGF5bG9hZCI6eyJjbGllbnRJZGVudGl0eSI6eyJjbGllbnRLZXkiOiJsNzZkNzc5NTNhMGYzMjRmYTI5MTA4MzRlNjMyZmI3OWVkIn0sImF1dGhlbnRpY2F0aW9uUmVhbG0iOiJDTUFDIiwiYWRkaXRpb25hbElkZW50aXR5Ijp7InRpbWVTdGFtcCI6IjEzLU5vdi0yMDIyIDIyOjQ1OjI5IEVTVCIsImdyYW50X3R5cGUiOiJjbGllbnRfY3JlZGVudGlhbHMiLCJhcGltb2RlIjoiU2FuZGJveCIsImN4c0lzcyI6Imh0dHBzOi8vY3hzYXV0aHNlcnZlci1wcm9kLmFwcC5wYWFzLmZlZGV4LmNvbS90b2tlbi9vYXV0aDIifSwicGVyc29uYVR5cGUiOiJEaXJlY3RJbn   <... truncated: 642 ...>   67s_kUdDGp-qgdr6DcwIP9u5JCYsByzGaFsEsLP4Wjv2PWQQkBeJ-f4GUaovDgJlxkFHyNor3Ga9ri1ckBc8jPi1p3Q_nGvtC_GUTNOhXYAcjM9MW4j8FCBxL-5b7Z8FDloS5i1szsRfWPOA","token_type":"bearer","expires_in":3599,"scope":"CXS"}';
    mock.addResponse(mockTokenJson, 200);
    String mockRateOptionsJson = '{"transactionId":"3b97a252-2f32-491c-b877-95e94ead28ec","errors":[{"code":"COUNTRY.POSTALCODE.INVALID","message":"Origin postal code is required or invalid."}]}';
    mock.addResponse(mockRateOptionsJson, 400);

    Test.setMock(HttpCalloutMock.class, mock);
    String recipient = '{"city":"Mountain View","street":"468 Ellis Street","state":"CA","countryCode":"US","countryLabel":"United States","postalCode":"94043","country":"United States"}';
    String shipper = '{"city":"Menlo Park","street":"Facebook Way","state":"CA","countryCode":"US","countryLabel":"United States","postalCode":"","country":"United States"}';
    Decimal weight = 15.00;
    String errorMessage = '';
    test.startTest();
    try {
      String response = FedexRateExtractorController.getRateOptions(
        recipient,
        shipper,
        weight
      );
    } catch (AuraHandledException e) {
      errorMessage = e.getMessage();
    }
    test.stopTest();

    System.assertEquals('Script-thrown exception', errorMessage);
  }
}
